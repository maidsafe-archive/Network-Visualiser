<html>
	<head>
		<script src="js/d3/d3.min.js" charset="utf-8"></script>
		<script src="js/con_map_transform.js" charset="utf-8"></script>
		<script type="application/javascript" src="js/events.js"></script>
		<link rel="stylesheet" type="text/css" href="css/d3.css"></link>	
	<style>
		svg {
			border: 1px solid #ccc;
		}		
		.link {
			stroke:#98C2E5;
		}
		.link.grey {
			stroke:#CCCCCC;
		}		
		.link.target {
			stroke:#CCCCCC;
			stroke-width: 1px;
		}
		.link.source {
			stroke:#CCCCCC;
			stroke-width: 1;			
		}
						
		.link.not-exp{
			stroke:#F7931E;
			stroke-dasharray: 7,4;
			stroke-width:1.5;
			stroke-opacity:1;
		}
		
		.link.missing{
			stroke:#ED1C24;
			stroke-dasharray: 7,4;
			stroke-width:1.5;
			stroke-opacity:1;
		}
		
		.link.missing.grey , .link.not-exp.grey {
			stroke:#CCCCCC;
			stroke-dasharray: none;
			stroke-opacity:.5;
		}
		
		.link.source.grey {
			stroke:#CCCCCC;
			stroke-width: 1;
			stroke-opacity:.5;
		}
		.link.source.missing-expected{
			stroke:#ED1C24;		
			stroke-dasharray : 7,4;
			stroke-width:1.5;
			stroke-opacity:1;	
		}
		.link.source.in{
			stroke:#0DB535;
			stroke-width:1.5;
			stroke-opacity:1;
		}		
		.link.source.out{
			stroke:#ED1C24;
			stroke-width:1.5;
			stroke-opacity:1;
		}
		.link.source.not-expected {
			stroke:#F7931E;
			stroke-dasharray: 7,4;
			stroke-width:1.5;
			stroke-opacity:1;
		}
		.link.source.close-group {
			stroke:#5593D7;
			stroke-dasharray : 7,4;
			stroke-width:1.5;
			stroke-opacity:1;
		}
		.link.source.group{
			stroke:#98C2E5;
			stroke-width:1.5;
			stroke-opacity:1;
		}
		.link.target.overlaped-target { 
			fill: none;
			stroke: #5593D7;
			stroke-opacity: .1;
			pointer-events: none;
		}
		.node text {
			fill: #999999;
		}
		.node text.red {
			fill:#ED1C24;
		}
		.node text.green {
			fill:#0DB535;
		}
		.node text.blue {
			fill:#5593D7;
		}
		.node text.light-blue {
			fill:#98C2E5;
		}
		.node text.orange {
			fill:#F7931E;
		}
		.node text.selected {
			fill:black;
			font-weight: bold;
		}
		.node circle {
			fill:white;
			stroke:#808080;
			stroke-width:1.2;
		}
		.node circle.full {
			fill:#808080;
		}
	</style>
	</head>
	<body>
		<script>
			
			d3.json('data.json', DrawConnectionMap);
			
			function DrawConnectionMap(connectionMap) {
				var div = d3.select('body');

				// Constants
				// ---------
				var WIDTH = 1000,
						HEIGHT = 500,
						RADIUS_X = WIDTH / 2,
						RADIUS_Y = HEIGHT / 2,
						CIRCLE_TEXT_GAP = 18,
						CIRCLE_LINE_GAP = 3,
						CIRCLE_FULL_LIMIT = 5,
						CIRCLE_SIZE = 3;						
				

				// Helpers
				// -------
				var lastDragPosition, transX = RADIUS_X, transY = RADIUS_Y; 
				function zoom() {
					if(lastDragPosition) {
							transX += (-1 * ( lastDragPosition.sourceEvent.offsetX - d3.event.sourceEvent.offsetX ));
							transY += (-1 * ( lastDragPosition.sourceEvent.offsetY - d3.event.sourceEvent.offsetY ));
					}				
					svg.attr("transform", "translate(" + [transX, transY] + ")scale(" + d3.event.scale + ")");
				}
				var dragEvent = d3.behavior.drag()
					.on('dragstart', function(){						
						lastDragPosition = d3.event;
					}).on('drag', function() {
						lastDragPosition = d3.event;
					})
					.on("dragend", function(){
						lastDragPosition = null;	
					});

				var cluster = d3.layout.cluster().
					size([360, RADIUS_Y/2])
					.sort(function(a, b) { return d3.ascending(a.name, b.name); });

				var bundle = d3.layout.bundle();

				var line = d3.svg.line.radial().
					interpolate("bundle").
					tension(.85).					
					radius(function(d) { return d.y; }).
					angle(function(d) { return d.x / 180 * Math.PI; });						

				var svg = div.append("svg:svg").
								attr("preserveAspectRatio", "xMinYMin meet").
								attr("viewBox", [0, 0, WIDTH, HEIGHT].join(' ')).
								attr("height", HEIGHT).
							append("svg:g").
								call(d3.behavior.zoom().scaleExtent([-5, 20]).on("zoom", zoom)).call(dragEvent).
								attr("transform", "translate(" + RADIUS_X + "," + RADIUS_Y + ")");
					
				var transformedData = new ConnectionMapTransformer(connectionMap);
				window.events = new ConnectionEvents(svg);

				connectionMap.sort(function (a, b) {
					return  a.name < b.name;
				});
				svg.selectAll('*').remove();

				svg.append("svg:path")
					.attr("class", "arc")
					.attr("d", d3.svg.arc().outerRadius(RADIUS_Y - (RADIUS_Y/.33)).innerRadius(0).startAngle(0).endAngle(2 * Math.PI))
					.on("mousedown", events.mousedown);

				var nodes = cluster.nodes(transformedData.nodes);
				var splines = bundle(transformedData.links)
				var path = svg.selectAll("path.link")
						.data(transformedData.links)
					.enter().append("svg:path")
						.attr("class", function(d) { return "link source-" + d.source.name + " target-" + d.target.name; })							
						.attr("d", function(d, i) { return line(splines[i]); });

				var nodes = svg.selectAll("g.node")
						.data(nodes.filter(function(n) { return !n.children; }))
					.enter().append("svg:g")
						.attr("class", "node")
						.attr("id", function(d) { return "node-" + d.name; })
						.attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; });

				nodes.append("svg:text")
						.attr("dx", function(d) { return d.x < 180 ? CIRCLE_TEXT_GAP : -CIRCLE_TEXT_GAP })
						.attr("dy", ".31em")
						.attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
						.attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })						
						.text(function(d) { return d.name; })
						.on("mouseover", events.mouseover)
						.on("mouseout", events.mouseout)
						.on("click", events.mouseClick);
				nodes.append("svg:circle")
						.attr("cx", CIRCLE_SIZE)
						.attr("cy", CIRCLE_SIZE)
						.attr("r", CIRCLE_SIZE)
						.attr("transform", 'translate(' + CIRCLE_LINE_GAP +  ',-' + CIRCLE_LINE_GAP + ')')
						.classed('full', function(d){return d.group && d.group.length == CIRCLE_FULL_LIMIT});
				
				events.updateLinksOnLoad(nodes);
							
		};
		</script>
		<button onclick="events.setMode(2)">CHURN</button>
		<button onclick="events.setMode(1)">CONNECTIVITY</button>
	</body>
</html>